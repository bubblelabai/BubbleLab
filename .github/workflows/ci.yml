name: CI

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

permissions:
  contents: write
  pull-requests: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Version Check
        run: |
          echo "ðŸ” Checking versions..."
          echo "Node.js version: $(node --version)"
          echo "Bun version: $(bun --version)"
          echo "pnpm version: $(pnpm --version)"
          echo ""
          echo "ðŸ“¦ Package versions:"
          echo "Root package: $(node -p "require('./package.json').version || 'N/A'")"
          echo ""
          echo "Core packages:"
          echo "- @bubblelab/bubble-core: $(node -p "require('./packages/bubble-core/package.json').version")"
          echo "- @bubblelab/bubble-runtime: $(node -p "require('./packages/bubble-runtime/package.json').version")"
          echo "- @bubblelab/shared-schemas: $(node -p "require('./packages/bubble-shared-schemas/package.json').version")"
          echo "- create-bubblelab-app: $(node -p "require('./packages/create-bubblelab-app/package.json').version")"
          echo ""
          echo "ðŸ”§ Tool versions:"
          echo "- TypeScript: $(npx tsc --version)"
          echo "- ESLint: $(npx eslint --version)"
          echo "- Turbo: $(npx turbo --version)"
          echo ""
          echo "ðŸŒ Environment:"
          echo "- OS: $(uname -a)"
          echo "- Architecture: $(uname -m)"
          echo "- Available memory: $(free -h | grep '^Mem:' | awk '{print $2}')"
          echo "- Disk space: $(df -h / | tail -1 | awk '{print $4}')"
          echo ""
          echo "ðŸ“‹ Dependency validation:"
          echo "Checking for version mismatches..."
          pnpm list --depth=0 --json | jq -r '.dependencies | to_entries[] | select(.value.version != .value.resolved) | "âš ï¸  \(.key): \(.value.version) vs \(.value.resolved)"' || echo "âœ… No version mismatches found"
          echo ""
          echo "âœ… Version check completed"

      - name: Setup test database
        run: |
          cd apps/bubblelab-api
          pnpm db:migrate
          cd ../..

      - name: Run type checking
        run: pnpm typecheck

      - name: Run linting
        run: pnpm lint

      - name: Run tests
        run: pnpm test
        env:
          CREDENTIAL_ENCRYPTION_KEY: ${{ secrets.CREDENTIAL_ENCRYPTION_KEY || 'test-encryption-key-that-is-32-chars-long-for-testing' }}

  publish:
    needs: test
    runs-on: ubuntu-latest
    # Only run on push to main
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 2 # Need previous commit to compare versions

      - name: Check if version changed
        id: version_check
        run: |
          # Compare bubble-core version in current commit vs previous
          PREV_VERSION=$(git show HEAD~1:packages/bubble-core/package.json 2>/dev/null | jq -r .version || echo "0.0.0")
          CURR_VERSION=$(jq -r .version packages/bubble-core/package.json)
          echo "Previous version: $PREV_VERSION"
          echo "Current version: $CURR_VERSION"
          if [ "$PREV_VERSION" != "$CURR_VERSION" ]; then
            echo "âœ… Version changed! Will publish."
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$CURR_VERSION" >> $GITHUB_OUTPUT
          else
            echo "â­ï¸ Version unchanged. Skipping publish."
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        if: steps.version_check.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install pnpm
        if: steps.version_check.outputs.changed == 'true'
        uses: pnpm/action-setup@v4
        with:
          run_install: false

      - name: Install dependencies
        if: steps.version_check.outputs.changed == 'true'
        run: pnpm install --frozen-lockfile

      - name: Build packages
        if: steps.version_check.outputs.changed == 'true'
        run: pnpm build:core

      - name: Publish packages
        if: steps.version_check.outputs.changed == 'true'
        run: |
          echo "ðŸ“¦ Publishing version ${{ steps.version_check.outputs.version }}"
          pnpm --filter "@bubblelab/shared-schemas" publish --access public --no-git-checks
          pnpm --filter "@bubblelab/bubble-core" publish --access public --no-git-checks
          pnpm --filter "@bubblelab/bubble-runtime" publish --access public --no-git-checks
          pnpm --filter "create-bubblelab-app" publish --access public --no-git-checks
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
